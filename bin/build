#!/bin/bash

# I don't remember what this used to do. I should probably just delete it.
echo "This script doesn't work any more" >> /dev/stderr
exit 1

source $(dirname $0)/common.sh

# Die immediately if any command fails
set -e

# PROJECT_VERSION=$(head -1 project.clj | grep -oE '\d+\.\d+(\.\d+)?(-SNAPSHOT)?')
GIT_VERSION=$(git describe --tags)
GIT_SHA=$(git rev-parse HEAD)

function print_usage() {
  cat <<EOF
$(basename $0) [ --allow-dirty ] [ --verbose | -v ] [ --help | -h ]
EOF
}

while [[ "$1" != "" ]]; do
  case "$1" in
    "--allow-dirty")
      echo "Allowing uncommitted changes in the build."
      ALLOW_DIRTY=yes
      GIT_SHA="${GIT_SHA}-dirty"
      GIT_VERSION="${GIT_VERSION}-dirty"
      ;;
    "--verbose" | "-v")
      set -x
      ;;
    "--help" | "-h")
      print_usage
      exit 0
      ;;
  esac
  shift
done

if [[ ("$ALLOW_DIRTY" != "yes") && (-n "$(git status --porcelain)") ]]; then
  echo "Project directory has uncommitted changes. Refusing to build."
  exit 1
fi

echo "Building"

cd $(dirname $0)/..

package
